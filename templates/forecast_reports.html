{% extends "base.html" %}

{% block title %}Forecast & Reports - Forecast.vk{% endblock %}

{% block content %}
<section class="page-header">
  <h2>Forecast & Reports</h2>
  <p>View detailed reports and demand forecasting for your business</p>
</section>

<!-- Report Date Filter -->
<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">
    <h3>Report Settings</h3>
  </div>
  <div class="card-body" style="padding: 1.5rem;">
    <form id="report-filter-form" class="report-filter">
      <div class="filter-group">
        <label for="report-type">Report Type</label>
        <select id="report-type" name="report_type">
          <option value="weekly">Weekly Report</option>
          <option value="monthly">Monthly Report</option>
          <option value="yearly">Yearly Report</option>
          <option value="custom">Custom Date Range</option>
        </select>
      </div>
      
      <div class="filter-group" id="week-month-year-group">
        <label for="report-period">Period</label>
        <select id="report-period" name="report_period">
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>
      
      <div class="filter-group date-range-group" style="display: none;">
        <label for="start-date">Start Date</label>
        <input type="date" id="start-date" name="start_date">
      </div>
      
      <div class="filter-group date-range-group" style="display: none;">
        <label for="end-date">End Date</label>
        <input type="date" id="end-date" name="end_date">
      </div>
      
      <div class="filter-actions">
        <button type="submit" class="btn">Generate Report</button>
        <button type="button" id="save-report-btn" class="btn btn-secondary">Save Report</button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Indicator -->
<div id="loading-indicator" class="loading-container" style="display: none;">
  <div class="loading-dots">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
  <p>Generating report...</p>
</div>

<!-- Data Status Message -->
<div id="data-status-message" class="card" style="margin-bottom: 2rem; display: none;">
  <div class="card-body" style="padding: 1.5rem; text-align: center;">
    <h3>Insufficient Data</h3>
    <p>There is not enough data available to generate reports and forecasts for the selected period.</p>
    <p>Please add more sales and purchase data or select a different time period.</p>
  </div>
</div>

<!-- Summary Section -->
<div id="report-content" style="display: none;">
  <div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
      <h3>Business Summary</h3>
    </div>
    <div class="card-body" style="padding: 1.5rem;">
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Total Sales</div>
          <div class="summary-value" id="report-total-sales">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total Purchases</div>
          <div class="summary-value" id="report-total-purchases">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Net Profit</div>
          <div class="summary-value" id="report-net-profit">₹0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Profit Margin</div>
          <div class="summary-value" id="report-profit-margin">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sales Performance -->
  <div class="row">
    <div class="card" style="flex: 1; margin-right: 1rem;">
      <div class="card-header">
        <h3>Sales Performance</h3>
      </div>
      <div class="card-body" style="padding: 1.5rem;">
        <div class="chart-container" style="height: 300px;">
          <canvas id="report-sales-chart"></canvas>
        </div>
        <div class="table-container" style="margin-top: 2rem;">
          <h4>Top Selling Products</h4>
          <table id="top-products-table" class="report-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity Sold</th>
                <th>Revenue</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody id="top-products-body">
              <tr>
                <td colspan="4" class="loading-text">Loading product data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="flex: 1;">
      <div class="card-header">
        <h3>Customer Performance</h3>
      </div>
      <div class="card-body" style="padding: 1.5rem;">
        <div class="chart-container" style="height: 300px;">
          <canvas id="report-customers-chart"></canvas>
        </div>
        <div class="table-container" style="margin-top: 2rem;">
          <h4>Top Customers</h4>
          <table id="top-customers-table" class="report-table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Orders</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody id="top-customers-body">
              <tr>
                <td colspan="3" class="loading-text">Loading customer data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Forecast Section -->
  <div class="card" style="margin-top: 2rem;">
    <div class="card-header">
      <h3>Demand Forecast</h3>
    </div>
    <div class="card-body" style="padding: 1.5rem;">
      <div class="row">
        <div style="flex: 1; margin-right: 1rem;">
          <div class="chart-container" style="height: 300px;">
            <canvas id="forecast-chart"></canvas>
          </div>
        </div>
        <div style="flex: 1;">
          <div class="forecast-summary">
            <div class="summary-item">
              <div class="summary-label">Forecasted Sales (Next Month)</div>
              <div class="summary-value" id="forecast-next-month">₹0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Forecasted Growth</div>
              <div class="summary-value" id="forecast-growth">0%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Confidence Level</div>
              <div class="summary-value" id="forecast-confidence">Medium</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Forecast Period</div>
              <div class="summary-value" id="forecast-period">Next 3 Months</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="table-container" style="margin-top: 2rem;">
        <h4>Product Demand Forecast</h4>
        <table id="forecast-table" class="report-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Current Month</th>
              <th>Next Month</th>
              <th>2 Months Ahead</th>
              <th>3 Months Ahead</th>
              <th>Trend</th>
            </tr>
          </thead>
          <tbody id="forecast-body">
            <tr>
              <td colspan="6" class="loading-text">Loading forecast data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Print and Export Options -->
  <div class="action-buttons" style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
    <button id="print-report" class="btn btn-secondary">
      <i class="print-icon"></i> Print Report
    </button>
    <button id="export-pdf" class="btn btn-secondary">
      <i class="pdf-icon"></i> Export as PDF
    </button>
    <button id="export-excel" class="btn btn-secondary">
      <i class="excel-icon"></i> Export as Excel
    </button>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.report-filter {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  align-items: flex-end;
}

.filter-group {
  flex: 1;
  min-width: 200px;
}

.filter-group label {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--secondary-color);
}

.filter-group input,
.filter-group select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  background-color: rgba(255, 255, 255, 0.1);
  color: var(--secondary-color);
}

.filter-actions {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.summary-item {
  background-color: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  padding: 1.5rem;
  text-align: center;
}

.summary-label {
  color: var(--secondary-color);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.summary-value {
  font-size: 1.8rem;
  font-weight: bold;
  color: var(--accent-color);
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.report-table th,
.report-table td {
  padding: 0.75rem 1rem;
  text-align: left;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.report-table th {
  background-color: rgba(255, 255, 255, 0.05);
  font-weight: 600;
  color: var(--secondary-color);
}

.loading-text {
  text-align: center;
  padding: 1rem;
  color: rgba(255, 255, 255, 0.6);
}

.forecast-summary {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
  height: 100%;
  align-content: center;
}

@media (max-width: 768px) {
  .report-filter {
    flex-direction: column;
  }
  
  .filter-group {
    width: 100%;
  }
  
  .row {
    flex-direction: column;
  }
  
  .card {
    margin-right: 0 !important;
    margin-bottom: 1rem;
  }
  
  .forecast-summary {
    grid-template-columns: 1fr;
  }
}

.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  text-align: center;
  margin-bottom: 2rem;
}

.loading-dots {
  display: flex;
  justify-content: center;
  margin-bottom: 1rem;
}

.dot {
  width: 12px;
  height: 12px;
  margin: 0 5px;
  background-color: var(--accent-color);
  border-radius: 50%;
  display: inline-block;
  animation: dot-wave 1.5s infinite ease-in-out;
}

.dot:nth-child(1) {
  animation-delay: 0s;
}

.dot:nth-child(2) {
  animation-delay: 0.3s;
}

.dot:nth-child(3) {
  animation-delay: 0.6s;
}

.dot:nth-child(4) {
  animation-delay: 0.9s;
}

@keyframes dot-wave {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-15px);
  }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Include Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Include jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Include html2canvas for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Set Chart.js defaults
  Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
  Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
  Chart.defaults.font.family = "'Poppins', sans-serif";
  
  // Common chart options
  const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
          legend: {
              position: 'top',
              labels: {
                  padding: 20,
                  usePointStyle: true,
                  pointStyle: 'circle'
              }
          },
          tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                  size: 14,
                  weight: 'bold'
              },
              bodyFont: {
                  size: 13
              },
              padding: 15,
              cornerRadius: 5,
              displayColors: true
          }
      }
  };
  
  // Populate period dropdown based on report type
  const reportTypeSelect = document.getElementById('report-type');
  const reportPeriodSelect = document.getElementById('report-period');
  const dateRangeGroups = document.querySelectorAll('.date-range-group');
  const weekMonthYearGroup = document.getElementById('week-month-year-group');
  
  function populatePeriodOptions() {
    const reportType = reportTypeSelect.value;
    reportPeriodSelect.innerHTML = '';
    
    if (reportType === 'weekly') {
      // Get last 12 weeks
      const today = new Date();
      for (let i = 0; i < 12; i++) {
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - (today.getDay() + 7 * i));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const option = document.createElement('option');
        option.value = `${weekStart.toISOString().split('T')[0]},${weekEnd.toISOString().split('T')[0]}`;
        option.textContent = `${weekStart.toLocaleDateString('en-IN')} - ${weekEnd.toLocaleDateString('en-IN')}`;
        reportPeriodSelect.appendChild(option);
      }
    } else if (reportType === 'monthly') {
      // Get last 12 months
      const today = new Date();
      for (let i = 0; i < 12; i++) {
        const monthStart = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthEnd = new Date(today.getFullYear(), today.getMonth() - i + 1, 0);
        
        const option = document.createElement('option');
        option.value = `${monthStart.toISOString().split('T')[0]},${monthEnd.toISOString().split('T')[0]}`;
        option.textContent = monthStart.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
        reportPeriodSelect.appendChild(option);
      }
    } else if (reportType === 'yearly') {
      // Get last 5 years
      const currentYear = new Date().getFullYear();
      for (let i = 0; i < 5; i++) {
        const year = currentYear - i;
        const yearStart = new Date(year, 0, 1);
        const yearEnd = new Date(year, 11, 31);
        
        const option = document.createElement('option');
        option.value = `${yearStart.toISOString().split('T')[0]},${yearEnd.toISOString().split('T')[0]}`;
        option.textContent = year.toString();
        reportPeriodSelect.appendChild(option);
      }
    }
  }
  
  reportTypeSelect.addEventListener('change', function() {
    const reportType = this.value;
    
    if (reportType === 'custom') {
      weekMonthYearGroup.style.display = 'none';
      dateRangeGroups.forEach(group => group.style.display = 'block');
      
      // Set default date range to last 30 days
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('end-date').value = today.toISOString().split('T')[0];
    } else {
      weekMonthYearGroup.style.display = 'block';
      dateRangeGroups.forEach(group => group.style.display = 'none');
      populatePeriodOptions();
    }
  });
  
  // Initialize period options
  populatePeriodOptions();
  
  // Handle report form submission
  document.getElementById('report-filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    generateReport();
  });
  
  // Function to generate report
  function generateReport() {
    const reportType = reportTypeSelect.value;
    let startDate, endDate;
    
    if (reportType === 'custom') {
      startDate = new Date(document.getElementById('start-date').value);
      endDate = new Date(document.getElementById('end-date').value);
      // Set end date to end of day
      endDate.setHours(23, 59, 59, 999);
    } else {
      const periodValue = reportPeriodSelect.value;
      const dates = periodValue.split(',');
      startDate = new Date(dates[0]);
      endDate = new Date(dates[1]);
      // Set end date to end of day
      endDate.setHours(23, 59, 59, 999);
    }
    
    // Show loading state
    document.getElementById('data-status-message').style.display = 'none';
    document.getElementById('report-content').style.display = 'none';
    document.getElementById('loading-indicator').style.display = 'flex';
    
    // Fetch data for the report
    Promise.all([
      fetch('/api/sales').then(response => response.json()),
      fetch('/api/purchases').then(response => response.json()),
      fetch('/api/products').then(response => response.json()),
      fetch('/api/customers').then(response => response.json())
    ])
    .then(([sales, purchases, products, customers]) => {
      // Hide loading indicator
      document.getElementById('loading-indicator').style.display = 'none';
      
      // Filter data by date range
      const filteredSales = sales.filter(sale => {
        const saleDate = new Date(sale.sale_date);
        return saleDate >= startDate && saleDate <= endDate;
      });
      
      const filteredPurchases = purchases.filter(purchase => {
        const purchaseDate = new Date(purchase.purchase_date);
        return purchaseDate >= startDate && purchaseDate <= endDate;
      });
      
      // Check if there's enough data to generate a report
      if (filteredSales.length === 0 && filteredPurchases.length === 0) {
        // Show insufficient data message
        document.getElementById('data-status-message').style.display = 'block';
        document.getElementById('report-content').style.display = 'none';
        return;
      }
      
      // Process data for report
      const reportData = processReportData(filteredSales, filteredPurchases, products, customers);
      
      // Update report UI
      updateReportUI(reportData, reportType, startDate, endDate);
      
      // Generate forecast data
      generateForecastData(sales, products);
      
      // Show report content
      document.getElementById('data-status-message').style.display = 'none';
      document.getElementById('report-content').style.display = 'block';
    })
    .catch(error => {
      console.error('Error fetching data:', error);
      // Show insufficient data message
      document.getElementById('data-status-message').style.display = 'block';
      document.getElementById('report-content').style.display = 'none';
      document.getElementById('loading-indicator').style.display = 'none';
    });
  }
  
  // Process data for report
  function processReportData(sales, purchases, products, customers) {
    // Calculate total sales, purchases, and profit
    const totalSales = sales.reduce((sum, sale) => sum + sale.total_amount, 0);
    const totalPurchases = purchases.reduce((sum, purchase) => sum + purchase.total_amount, 0);
    const netProfit = totalSales - totalPurchases;
    const profitMargin = totalSales > 0 ? (netProfit / totalSales) * 100 : 0;
    
    // Process sales by day
    const salesByDay = {};
    sales.forEach(sale => {
      const saleDate = new Date(sale.sale_date).toISOString().split('T')[0];
      if (!salesByDay[saleDate]) {
        salesByDay[saleDate] = 0;
      }
      salesByDay[saleDate] += sale.total_amount;
    });
    
    // Process top selling products
    const productSales = {};
    sales.forEach(sale => {
      sale.items.forEach(item => {
        if (!productSales[item.product_id]) {
          productSales[item.product_id] = {
            name: item.product_name,
            quantity: 0,
            revenue: 0,
            cost: 0
          };
        }
        productSales[item.product_id].quantity += item.quantity;
        productSales[item.product_id].revenue += item.total_price;
        
        // Estimate cost based on unit price
        const product = products.find(p => p.product_id === item.product_id);
        if (product) {
          productSales[item.product_id].cost += item.quantity * product.cost_per_unit;
        }
      });
    });
    
    // Calculate profit for each product
    Object.values(productSales).forEach(product => {
      product.profit = product.revenue - product.cost;
    });
    
    const topProducts = Object.entries(productSales)
      .map(([id, data]) => ({
        id,
        ...data
      }))
      .sort((a, b) => b.revenue - a.revenue)
      .slice(0, 5);
    
    // Process sales by customer
    const customerSales = {};
    sales.forEach(sale => {
      if (!customerSales[sale.customer_name]) {
        customerSales[sale.customer_name] = {
          totalAmount: 0,
          orderCount: 0
        };
      }
      customerSales[sale.customer_name].totalAmount += sale.total_amount;
      customerSales[sale.customer_name].orderCount += 1;
    });
    
    const topCustomers = Object.entries(customerSales)
      .map(([name, data]) => ({
        name,
        ...data
      }))
      .sort((a, b) => b.totalAmount - a.totalAmount)
      .slice(0, 5);
    
    return {
      totalSales,
      totalPurchases,
      netProfit,
      profitMargin,
      salesByDay,
      topProducts,
      topCustomers
    };
  }
  
  // Update report UI
  function updateReportUI(data, reportType, startDate, endDate) {
    // Format dates for display
    const startDateStr = startDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
    const endDateStr = endDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
    
    // Update summary section
    document.getElementById('report-total-sales').textContent = `₹${data.totalSales.toLocaleString('en-IN')}`;
    document.getElementById('report-total-purchases').textContent = `₹${data.totalPurchases.toLocaleString('en-IN')}`;
    document.getElementById('report-net-profit').textContent = `₹${data.netProfit.toLocaleString('en-IN')}`;
    document.getElementById('report-profit-margin').textContent = `${data.profitMargin.toFixed(1)}%`;
    
    // Update top products table
    updateTopProductsTable(data.topProducts);
    
    // Update top customers table
    updateTopCustomersTable(data.topCustomers);
    
    // Render charts
    renderSalesChart(data.salesByDay, reportType, startDate, endDate);
    renderCustomersChart(data.topCustomers);
  }
  
  // Update top products table
  function updateTopProductsTable(topProducts) {
    const tableBody = document.getElementById('top-products-body');
    
    if (topProducts.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="loading-text">No sales data available for the selected period</td></tr>`;
      return;
    }
    
    let rowsHTML = '';
    
    topProducts.forEach(product => {
      rowsHTML += `
        <tr>
          <td>${product.name}</td>
          <td>${product.quantity}</td>
          <td>₹${product.revenue.toLocaleString('en-IN')}</td>
          <td>₹${product.profit.toLocaleString('en-IN')}</td>
        </tr>
      `;
    });
    
    tableBody.innerHTML = rowsHTML;
  }
  
  // Update top customers table
  function updateTopCustomersTable(topCustomers) {
    const tableBody = document.getElementById('top-customers-body');
    
    if (topCustomers.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="3" class="loading-text">No customer data available for the selected period</td></tr>`;
      return;
    }
    
    let rowsHTML = '';
    
    topCustomers.forEach(customer => {
      rowsHTML += `
        <tr>
          <td>${customer.name}</td>
          <td>${customer.orderCount}</td>
          <td>₹${customer.totalAmount.toLocaleString('en-IN')}</td>
        </tr>
      `;
    });
    
    tableBody.innerHTML = rowsHTML;
  }
  
  // Render sales chart
  function renderSalesChart(salesByDay, reportType, startDate, endDate) {
    const ctx = document.getElementById('report-sales-chart').getContext('2d');
    
    // Prepare date labels and data
    const dateLabels = [];
    const salesData = [];
    
    // Generate all dates in the range
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
      const dateStr = currentDate.toISOString().split('T')[0];
      dateLabels.push(dateStr);
      salesData.push(salesByDay[dateStr] || 0);
      
      // Move to next day
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    // Format date labels based on report type
    const formattedLabels = dateLabels.map(dateStr => {
      const date = new Date(dateStr);
      if (reportType === 'monthly') {
        return date.toLocaleDateString('en-IN', { day: 'numeric' });
      } else if (reportType === 'yearly') {
        return date.toLocaleDateString('en-IN', { month: 'short' });
      } else {
        return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
      }
    });
    
    // Destroy previous chart if it exists
    if (window.salesChart) {
      window.salesChart.destroy();
    }
    
    // Create new chart
    window.salesChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: formattedLabels,
        datasets: [{
          label: 'Sales Amount',
          data: salesData,
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₹' + value.toLocaleString('en-IN');
              }
            }
          }
        }
      }
    });
  }
  
  // Render customers chart
  function renderCustomersChart(topCustomers) {
    const ctx = document.getElementById('report-customers-chart').getContext('2d');
    
    const customerNames = topCustomers.map(customer => customer.name);
    const customerAmounts = topCustomers.map(customer => customer.totalAmount);
    
    // Destroy previous chart if it exists
    if (window.customersChart) {
      window.customersChart.destroy();
    }
    
    // Create new chart
    window.customersChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: customerNames,
        datasets: [{
          data: customerAmounts,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        ...commonOptions,
        plugins: {
          ...commonOptions.plugins,
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ₹${value.toLocaleString('en-IN')} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }
  
  // Generate forecast data
  function generateForecastData(sales, products) {
    // Group sales by month
    const salesByMonth = {};
    const productSalesByMonth = {};
    
    sales.forEach(sale => {
      const saleDate = new Date(sale.sale_date);
      const monthKey = `${saleDate.getFullYear()}-${saleDate.getMonth() + 1}`;
      
      if (!salesByMonth[monthKey]) {
        salesByMonth[monthKey] = 0;
      }
      
      salesByMonth[monthKey] += sale.total_amount;
      
      // Track product sales by month
      sale.items.forEach(item => {
        if (!productSalesByMonth[item.product_id]) {
          productSalesByMonth[item.product_id] = {};
        }
        
        if (!productSalesByMonth[item.product_id][monthKey]) {
          productSalesByMonth[item.product_id][monthKey] = {
            quantity: 0,
            revenue: 0
          };
        }
        
        productSalesByMonth[item.product_id][monthKey].quantity += item.quantity;
        productSalesByMonth[item.product_id][monthKey].revenue += item.total_price;
      });
    });
    
    // Sort months chronologically
    const sortedMonths = Object.keys(salesByMonth).sort();
    
    // Check if we have enough data for forecasting
    if (sortedMonths.length < 2) {
      // Not enough data for forecasting
      document.getElementById('forecast-next-month').textContent = 'Insufficient data';
      document.getElementById('forecast-growth').textContent = 'Insufficient data';
      document.getElementById('forecast-confidence').textContent = 'Low';
      document.getElementById('forecast-period').textContent = 'Next 3 Months';
      
      // Clear forecast chart
      const ctx = document.getElementById('forecast-chart').getContext('2d');
      if (window.forecastChart) {
        window.forecastChart.destroy();
      }
      window.forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Insufficient Data'],
          datasets: [{
            label: 'Historical Sales',
            data: [0],
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)'
          }]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            title: {
              display: true,
              text: 'Insufficient data for forecasting',
              font: {
                size: 16
              }
            }
          }
        }
      });
      
      // Clear forecast table
      document.getElementById('forecast-body').innerHTML = `<tr><td colspan="6" class="loading-text">Insufficient data for forecasting</td></tr>`;
      return;
    }
    
    // Get last 6 months of data for forecasting
    const recentMonths = sortedMonths.slice(-6);
    const recentSales = recentMonths.map(month => salesByMonth[month]);
    
    // Simple forecasting using moving average with trend
    const forecastMonths = 3;
    const forecastSales = [];
    
    // Calculate average monthly growth rate
    let growthRate = 0;
    if (recentSales.length >= 2) {
      let totalGrowth = 0;
      for (let i = 1; i < recentSales.length; i++) {
        if (recentSales[i-1] > 0) {
          totalGrowth += (recentSales[i] - recentSales[i-1]) / recentSales[i-1];
        }
      }
      growthRate = totalGrowth / (recentSales.length - 1);
    }
    
    // Cap growth rate between -20% and 30%
    growthRate = Math.max(-0.2, Math.min(0.3, growthRate));
    
    // Calculate moving average
    const movingAvgPeriod = Math.min(3, recentSales.length);
    const movingAvg = recentSales.slice(-movingAvgPeriod).reduce((sum, val) => sum + val, 0) / movingAvgPeriod;
    
    // Generate forecast for next 3 months
    for (let i = 1; i <= forecastMonths; i++) {
      forecastSales.push(movingAvg * Math.pow(1 + growthRate, i));
    }
    
    // Generate next month names
    const lastMonth = new Date(recentMonths[recentMonths.length - 1].split('-')[0], recentMonths[recentMonths.length - 1].split('-')[1] - 1);
    const forecastMonthLabels = [];
    
    for (let i = 1; i <= forecastMonths; i++) {
      const forecastMonth = new Date(lastMonth);
      forecastMonth.setMonth(lastMonth.getMonth() + i);
      forecastMonthLabels.push(forecastMonth.toLocaleDateString('en-IN', { month: 'short', year: 'numeric' }));
    }
    
    // Update forecast summary
    document.getElementById('forecast-next-month').textContent = `₹${forecastSales[0].toLocaleString('en-IN')}`;
    document.getElementById('forecast-growth').textContent = `${(growthRate * 100).toFixed(1)}%`;
    document.getElementById('forecast-confidence').textContent = recentSales.length >= 4 ? 'Medium' : 'Low';
    document.getElementById('forecast-period').textContent = `Next ${forecastMonths} Months`;
    
    // Render forecast chart
    renderForecastChart(recentMonths, recentSales, forecastMonthLabels, forecastSales);
    
    // Generate product forecasts
    generateProductForecasts(productSalesByMonth, products, recentMonths, forecastMonthLabels);
  }
  
  // Render forecast chart
  function renderForecastChart(recentMonths, recentSales, forecastMonthLabels, forecastSales) {
    const ctx = document.getElementById('forecast-chart').getContext('2d');
    
    // Format month labels
    const recentMonthLabels = recentMonths.map(month => {
      const year = month.split('-')[0];
      const monthNum = month.split('-')[1];
      return new Date(year, monthNum - 1).toLocaleDateString('en-IN', { month: 'short', year: 'numeric' });
    });
    
    // Destroy previous chart if it exists
    if (window.forecastChart) {
      window.forecastChart.destroy();
    }
    
    // Create new chart
    window.forecastChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [...recentMonthLabels, ...forecastMonthLabels],
        datasets: [
          {
            label: 'Historical Sales',
            data: [...recentSales, ...Array(forecastMonthLabels.length).fill(null)],
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.4,
            fill: true
          },
          {
            label: 'Forecasted Sales',
            data: [...Array(recentMonthLabels.length).fill(null), ...forecastSales],
            borderColor: 'rgba(255, 159, 64, 1)',
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            borderDash: [5, 5],
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₹' + value.toLocaleString('en-IN');
              }
            }
          }
        }
      }
    });
  }
  
  // Generate product forecasts
  function generateProductForecasts(productSalesByMonth, products, recentMonths, forecastMonthLabels) {
    const forecastTableBody = document.getElementById('forecast-body');
    const productForecasts = [];
    
    // Process each product
    Object.entries(productSalesByMonth).forEach(([productId, monthlySales]) => {
      const product = products.find(p => p.product_id === productId);
      if (!product) return;
      
      // Get recent sales data
      const recentSalesData = recentMonths.map(month => 
        (monthlySales[month] && monthlySales[month].quantity) || 0
      );
      
      // Calculate growth rate
      let growthRate = 0;
      if (recentSalesData.length >= 2) {
        let totalGrowth = 0;
        let validMonths = 0;
        
        for (let i = 1; i < recentSalesData.length; i++) {
          if (recentSalesData[i-1] > 0) {
            totalGrowth += (recentSalesData[i] - recentSalesData[i-1]) / recentSalesData[i-1];
            validMonths++;
          }
        }
        
        growthRate = validMonths > 0 ? totalGrowth / validMonths : 0;
      }
      
      // Cap growth rate
      growthRate = Math.max(-0.3, Math.min(0.4, growthRate));
      
      // Calculate moving average
      const movingAvgPeriod = Math.min(3, recentSalesData.length);
      const movingAvg = recentSalesData.slice(-movingAvgPeriod).reduce((sum, val) => sum + val, 0) / movingAvgPeriod;
      
      // Generate forecast for next 3 months
      const forecastData = [];
      for (let i = 1; i <= 3; i++) {
        forecastData.push(Math.round(movingAvg * Math.pow(1 + growthRate, i)));
      }
      
      // Determine trend
      let trend = 'Stable';
      if (growthRate > 0.05) trend = 'Increasing';
      else if (growthRate < -0.05) trend = 'Decreasing';
      
      // Add to product forecasts
      productForecasts.push({
        name: product.name,
        currentMonth: recentSalesData[recentSalesData.length - 1] || 0,
        forecast: forecastData,
        trend: trend
      });
    });
    
    // Sort by current month sales (descending)
    productForecasts.sort((a, b) => b.currentMonth - a.currentMonth);
    
    // Take top 10 products
    const topProductForecasts = productForecasts.slice(0, 10);
    
    // Generate table rows
    if (topProductForecasts.length === 0) {
      forecastTableBody.innerHTML = `<tr><td colspan="6" class="loading-text">No forecast data available</td></tr>`;
      return;
    }
    
    let rowsHTML = '';
    
    topProductForecasts.forEach(forecast => {
      const trendClass = forecast.trend === 'Increasing' ? 'up' : (forecast.trend === 'Decreasing' ? 'down' : '');
      const trendIcon = forecast.trend === 'Increasing' ? '↑' : (forecast.trend === 'Decreasing' ? '↓' : '→');
      
      rowsHTML += `
        <tr>
          <td>${forecast.name}</td>
          <td>${forecast.currentMonth}</td>
          <td>${forecast.forecast[0]}</td>
          <td>${forecast.forecast[1]}</td>
          <td>${forecast.forecast[2]}</td>
          <td class="trend ${trendClass}">${trendIcon} ${forecast.trend}</td>
        </tr>
      `;
    });
    
    forecastTableBody.innerHTML = rowsHTML;
  }
  
  // Handle print button
  document.getElementById('print-report').addEventListener('click', function() {
    window.print();
  });
  
  // Handle PDF export
  document.getElementById('export-pdf').addEventListener('click', function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Get report title based on report type
    const reportType = document.getElementById('report-type').value;
    let reportTitle = 'Weekly Report';
    
    if (reportType === 'monthly') {
      reportTitle = 'Monthly Report';
    } else if (reportType === 'yearly') {
      reportTitle = 'Yearly Report';
    } else if (reportType === 'custom') {
      reportTitle = 'Custom Report';
    }
    
    // Add report title
    doc.setFontSize(18);
    doc.text(reportTitle, 105, 15, { align: 'center' });
    
    // Add date range
    let dateRange = '';
    if (reportType === 'custom') {
      const startDate = new Date(document.getElementById('start-date').value);
      const endDate = new Date(document.getElementById('end-date').value);
      dateRange = `${startDate.toLocaleDateString('en-IN')} - ${endDate.toLocaleDateString('en-IN')}`;
    } else {
      const periodValue = document.getElementById('report-period').value;
      const dates = periodValue.split(',');
      const startDate = new Date(dates[0]);
      const endDate = new Date(dates[1]);
      dateRange = `${startDate.toLocaleDateString('en-IN')} - ${endDate.toLocaleDateString('en-IN')}`;
    }
    
    doc.setFontSize(12);
    doc.text(`Date: ${dateRange}`, 105, 25, { align: 'center' });
    
    // Use html2canvas to capture charts and tables
    html2canvas(document.querySelector('.card')).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      doc.addImage(imgData, 'PNG', 10, 30, 190, 100);
      
      // Save the PDF
      doc.save(`${reportTitle.replace(' ', '_')}_${dateRange.replace(/\//g, '-')}.pdf`);
    });
  });
  
  // Handle Excel export
  document.getElementById('export-excel').addEventListener('click', function() {
    // This is a simplified version - in a real app, you'd use a library like SheetJS
    alert('Excel export functionality would be implemented here with a library like SheetJS');
  });
  
  // Generate initial report
  generateReport();
});
</script>
{% endblock %}

